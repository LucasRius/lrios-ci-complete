# Caminho: .github/workflows/ci-deploy-gitops-kotlin.yml
name: Reusable GitOps Update (DockerHub)

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
        description: 'Nome do microserviﾃｧo (ex: servico-a)'
      target_env:
        required: true
        type: string
        description: 'Ambiente de destino (ex: prod)'
      image_tag:
        required: true
        type: string
        description: 'Tag da imagem Docker recﾃｩm-construﾃｭda (SHA curta)'
      dockerhub_repo:
        required: true
        type: string
        description: 'Nome completo do repositﾃｳrio DockerHub (ex: username/servico-a)'
      app_config_path:
        required: true
        type: string
        description: 'Caminho para o deployment-config.yaml no repositﾃｳrio chamador (contﾃｩm as configuraﾃｧﾃｵes de infra/Helm)'
    secrets:
      GITOPS_TOKEN:
        required: true
        description: 'Token com permissﾃ｣o de escrita no Repositﾃｳrio GitOps (lrios-gitops)'

jobs:
  update-gitops:
    runs-on: ubuntu-latest
    permissions:
      # Permissﾃ｣o necessﾃ｡ria no job chamador (ci.yml) para passar o GITHUB_TOKEN
      contents: write 

    steps:
      
      # 1. Checkout do Repositﾃｳrio GitOps (CORREﾃﾃグ: Usar o GITOPS_TOKEN para escrita)
      - name: Checkout GitOps Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/lrios-gitops
          token: ${{ secrets.GITOPS_TOKEN }} # Usa o token de escrita
          path: gitops-config 
          
      # 2. Configuraﾃｧﾃ｣o do Git
      - name: Configure Git
        run: |
          cd gitops-config
          git config user.name "GitHub Actions Bot"
          git config user.email "ci-bot@${{ github.repository_owner }}.com"

      # 3. Checkout do Repositﾃｳrio Chamador para obter o arquivo de configuraﾃｧﾃ｣o
      - name: Checkout Repositﾃｳrio Chamador para Configuraﾃｧﾃ｣o
        uses: actions/checkout@v4
        with:
          path: app-config-source
          repository: ${{ github.event.repository.full_name }}
          ref: ${{ github.sha }}
          # Usa o GITHUB_TOKEN (padrﾃ｣o) para acesso de leitura ao repo chamador
          token: ${{ github.token }}
          
      # 4. Instalar yq (Necessﾃ｡rio para manipulaﾃｧﾃ｣o YAML estrutural)
      - name: Instalar yq
        run: sudo snap install yq --classic # Ou 'sudo apt-get install -y yq' em alguns runners
        shell: bash
        
      # 5. CRIAﾃﾃグ E ATUALIZAﾃﾃグ ESTRUTURAL DO values.yaml
      - name: Generate Final values.yaml
        run: |
          CONFIG_DIR="gitops-config/apps/${{ inputs.service_name }}/${{ inputs.target_env }}"
          CONFIG_PATH="${CONFIG_DIR}/values.yaml"
          
          # Variﾃ｡vel de entrada limpa (ex: a61de58)
          CLEAN_TAG="${{ inputs.image_tag }}" 
          
          # 徴 CORREﾃﾃグ ESSENCIAL: Recria a tag com o prefixo 'sha-'
          TAG_COM_PREFIXO="sha-$CLEAN_TAG" 
          
          # ... (copia o arquivo base)
          cp app-config-source/${{ inputs.app_config_path }} $CONFIG_PATH

          # ... (Atualiza o repositﾃｳrio)
          yq e ".image.repository = \"${{ inputs.dockerhub_repo }}\"" -i $CONFIG_PATH
          
          # 徴 Usa a tag prefixada para coincidir com o Docker Hub
          yq e ".image.tag = \"$TAG_COM_PREFIXO\"" -i $CONFIG_PATH
          
          echo "Tag escrita no GitOps: $TAG_COM_PREFIXO"
          
      # 6. Commit e Push (CORREﾃﾃグ: Injetar o GITOPS_TOKEN na URL para autenticaﾃｧﾃ｣o)
      - name: Commit and Push Changes
        run: |
          cd gitops-config
          git add .
          
          if ! git diff --cached --exit-code; then
              git commit -m "feat(${{ inputs.service_name }}): Automated deployment for ${{ inputs.target_env }} image: ${{ inputs.image_tag }}"
              
              REMOTE_URL=$(git config --get remote.origin.url)
              
              # Injeta o GITOPS_TOKEN na URL remota para autenticar o push (Correﾃｧﾃ｣o de Auth 403)
              AUTH_URL="https://${{ secrets.GITOPS_TOKEN }}@${REMOTE_URL#https://}" 
              
              git push $AUTH_URL main 
          else
              echo "Nﾃ｣o houve alteraﾃｧﾃｵes no values.yaml, deploy ignorado."
          fi