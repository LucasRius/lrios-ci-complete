name: CI  LINT Pipeline Node

on:
    workflow_call:
        inputs:
            build_tool:
                description: "Escolha o build da sua aplicacao."
                type: string
            lint_pre_hook:
                description: "Script Pre Hook do linting"
                type: string
                default: 'echo "pre hook lint nao utilizado"'
            lint_post_hook:
                description: "Script Post Hook do linting"
                type: string
                default: 'echo "post hook lint nao utilizado"'
            lint_bypass:
                type: string
                description: "Toogle para forcar ou nao a quebra do lint"
                default: "false"
            cache_path:
                type: string
                description: "Path to cache"
            lint-node-command:
                description: ""
                type: string
                default: "lint"
            working_directory:
                description: "Diretorio de trabalho padrao"
                type: string
                default: "."
jobs:
    linting:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3
            - name: Setup  Java
              id: action_setup_java
              uses: LucasRius/lrios-ci-complete/.github/actions/setup-node@main
              with:
                  jdk_cache: ${{ inputs.build_tool }}
                  cache_path: ${{ inputs.cache_path }}
            - name: Lint ByPass
              id: lint-bypass-var
              run: |
                  TOGGLE_LINT_BYPASS="${{ vars.TOGGLE_LINT_BYPASS }}"
                  PARAM_VALUE="${{ inputs.lint_bypass }}"    

                  if [ "$TOGGLE_LINT_BYPASS" == "true" ] && [ "$PARAM_VALUE" == "true" ]; then
                      RESULTADO="true"
                  else
                      RESULTADO="false"
                  fi
                  echo "action_enabled=$RESULTADO" >> $GITHUB_OUTPUT

                  echo "Status da TOGGLE_LINT_BYPASS: $TOGGLE_LINT_BYPASS"
                  echo "Status da Variável Parametrizável: $PARAM_VALUE"
                  echo "Variável de Saída 'action_enabled': $RESULTADO"
            - name: Pre Hook Lint
              run: |
                  ${{ inputs.lint_pre_hook }}
            - name: Lint Node
              if: ${{ inputs.build_tool  == 'yarn'  || inputs.build_tool  == 'npm' || inputs.build_tool  == 'pnpm'}}
              id: lint-node
              shell: bash
              working-directory: ${{ inputs.working_directory }}
              run: |
                  case "${{ inputs.build_tool}}" in
                  npm)
                      npm  ${{ inputs.lint-node-command}}
                      ;;
                  yarn)
                      yarn  ${{ inputs.lint-node-command }}
                      ;;
                  pnpm)
                      pnpm  ${{ inputs.lint-node-command }}
                  *)
                      echo "Package nao suportado: ${{ inputs.build_tool}}"
                      exit 1
                      ;;
                  esac

              continue-on-error: ${{ fromJson(steps.lint-bypass-var.outputs.action_enabled) }}
            - name: Post Hook Lint
              run: |
                  ${{ inputs.lint_post_hook }}
