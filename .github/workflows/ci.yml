name: CI  Pipeline

on:
  workflow_call:
    inputs:
      working_directory:
        description: 'Diretorio de trabalho padrao'
        type: string
        default: '.'
      language:
        description: "Escolha entre kotlin, scala, node"
        type: string
      language_version:
        description: "Escolha entre kotlin, scala, node"
        type: string
        default: '21'
      build_tool:
        description: "Escolha o build da sua aplicacao. gradle, sbt, yarn"
        type: string
      lint_pre_hook:
        description: "Script Pre Hook do linting"
        type: string
        default: 'echo "pre hook lint nao utilizado"'
      lint_post_hook:
        description: "Script Post Hook do linting"
        type: string
        default: 'echo "post hook lint nao utilizado"'
      lint_bypass:
        type: string
        description: "Toogle para forcar ou nao a quebra do lint"
        default: "false"
      cache_path:
        type: string
        description: "Path to cache"
      always-auth:
        description: ''
        type: string
        default: 'false'
      lint-node-command:
        description: ''
        type: string
        default: 'lint'
      service-name:
        description: ''
        type: string
      target-env:
        description: ''
        type: string
      repo-env:
        description: ''
        type: string
        default: 'lucasrios92/teste-kotlin'




jobs:
  linting-kotlin:
    if: ${{ inputs.language  == 'kotlin' }}
    uses: LucasRius/lrios-ci-complete/.github/workflows/ci-lint-kotlin.yml@main
    with:
      build_tool: ${{ inputs.build_tool }}
      lint_pre_hook: ${{ inputs.lint_pre_hook }}
      lint_post_hook: ${{ inputs.lint_post_hook }}
      lint_bypass: ${{ inputs.lint_bypass }}
      language_version: ${{ inputs.language_version }}
      cache_path: ${{ inputs.cache_path }}
  linting-scala:
    if: ${{ inputs.language  == 'scala' }}
    uses: LucasRius/lrios-ci-complete/.github/workflows/ci-lint-scala.yml@main
    with:
      build_tool: ${{ inputs.build_tool }}
      lint_pre_hook: ${{ inputs.lint_pre_hook }}
      lint_post_hook: ${{ inputs.lint_post_hook }}
      lint_bypass: ${{ inputs.lint_bypass }}
      language_version: ${{ inputs.language_version }}
      cache_path: ${{ inputs.cache_path }}
  build-and-push-kotlin:
    needs: [linting-kotlin]
    name: Build e Envio para Docker Hub
    # Chama o workflow reutilizável
    uses: LucasRius/lrios-ci-complete/.github/workflows/ci-build-and-push-kotlin.yml@main

    with:
      # Passa o nome da imagem e a versão do Java como inputs
      language_version: ${{ inputs.language_version }}
      image_name: 'lucasrios92/teste-kotlin' # <<-- MUDAR AQUI

    secrets: inherit
  deploy-gitops:
    name: Trigger GitOps Update
    permissions:
      contents: write
    needs: build-and-push-kotlin
    uses: LucasRius/lrios-ci-complete/.github/workflows/ci-deploy-gitops-kotlin.yml@main
    with:
      service_name: ${{ inputs.service-name }}
      target_env: ${{ inputs.target-env }}
      image_tag: ${{ needs.build-and-push-kotlin.outputs.image_tag_sha }}
      dockerhub_repo: ${{ inputs.repo-env }}
      app_config_path: cicd/prd.yaml # Caminho de onde esta o arquivo de configuracao manifesto helm 
    secrets: inherit